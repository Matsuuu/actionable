name: Release pipeline

on:
  workflow_dispatch:
    inputs:
      track:
        description: "Which track are we releasing?"
        required: true
        type: choice
        options: [stable, beta, legacy]
      bump:
        description: "Semantic Version bump"
        required: true
        type: choice
        options: [major, minor, patch]
      ref:
        description: "Git ref to release from (branch or sha). Defaults to the triggering ref."
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: release-pipeline
  cancel-in-progress: false

jobs:
  versions:
    name: Get current release versions
    uses: ./.github/workflows/get-release-versions.yml
    secrets: inherit

  release:
    name: Bump, tag, release, move labels
    runs-on: ubuntu-latest
    needs: [versions]

    outputs:
      new_version: ${{ steps.plan.outputs.new_version }}

    env:
      TRACK: ${{ inputs.track }}
      BUMP: ${{ inputs.bump }}
      STABLE_VERSION: ${{ needs.versions.outputs.stable }}
      BETA_VERSION: ${{ needs.versions.outputs.beta }}
      LEGACY_VERSION: ${{ needs.versions.outputs.legacy }}
      # allow overriding the ref to release
      RELEASE_REF: ${{ inputs.ref || github.ref_name }}

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_REF }}

      - name: Init NodeJS
        uses: ./.github/actions/setup-github-actions-node

      - name: Configure git author
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3+4) Decide base version from track + compute NEW_VERSION
      - name: Plan version
        id: plan
        shell: bash
        run: node ./.github/scripts/plan-release.mjs

      - name: Bump versions
        shell: bash
        env:
          NEW_VERSION: ${{ steps.plan.outputs.new_version }}
        run: node ./.github/scripts/bump-versions.mjs

      - name: Commit version bump
        shell: bash
        run: |
          if git diff --quiet; then
            echo "No changes after version bump (nothing to commit)."
            exit 0
          fi
          git add -A
          git commit -m "Release: ${{ steps.plan.outputs.new_version }}"

      - name: Create and push tags
        shell: bash
        env:
          NEW_VERSION: ${{ steps.plan.outputs.new_version }}
          TRACK: ${{ inputs.track  }}
        run: node ./.github/scripts/push-tags.mjs

      - name: Create a Release on GitHub
        uses: ncipollo/release-action@v1 # v1
        with:
          ref: ${{ env.RELEASE_REF }}
          tag: ${{ steps.plan.outputs.new_version_tag }}
          prerelease: ${{  inputs.track == 'beta' }}
          makeLatest: false
          body: Release ${{ steps.plan.outputs.new_version  }}

      # - name: Create mirrored release for track tag
      #   shell: bash
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   working-directory: ./.github/scripts
      #   run: |
      #     node ./create-mirrored-track-release.mjs \
      #       --track "${{ env.TRACK }}" \
      #       --source-tag "release/${{ steps.plan.outputs.new_version }}"

      # - name: Move tags/labels
      #   shell: bash
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   working-directory: ./.github/scripts
      #   run: |
      #     node ./post-release-maintenance.mjs \
      #       --track "${{ env.TRACK }}" \
      #       --bump "${{ env.BUMP }}" \
      #       --new-version "${{ steps.plan.outputs.new_version }}" \
      #       --stable-version "${{ env.STABLE_VERSION }}" \
      #       --beta-version "${{ env.BETA_VERSION }}" \
      #       --legacy-version "${{ env.LEGACY_VERSION }}"

  # ensure_rc_branch:
  # name: Ensure RC branch exists
  # needs: [release]
  # uses: ./.github/workflows/ensure-release-candidate-branch.yml
  # secrets: inherit
  # with:
  # version: ${{ needs.release.outputs.new_version || '' }}
