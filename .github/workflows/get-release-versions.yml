name: Get Release Versions

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      stable:
        description: "Stable release version"
        value: ${{ jobs.get-versions.outputs.stable }}
      beta:
        description: "Beta release version"
        value: ${{ jobs.get-versions.outputs.beta }}
      legacy:
        description: "Legacy release version"
        value: ${{ jobs.get-versions.outputs.legacy }}

jobs:
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      stable: ${{ steps.get-tags.outputs.stable }}
      beta: ${{ steps.get-tags.outputs.beta }}
      legacy: ${{ steps.get-tags.outputs.legacy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # IMPORTANT: fetch full history + tags

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Extract release versions
        id: get-tags
        shell: bash
        run: |
          set -euo pipefail

          get_version_for_track() {
            local track="$1"

            if ! git rev-parse "$track" >/dev/null 2>&1; then
              echo ""
              return
            fi

            commit=$(git rev-parse "${track}^{}")

            git tag --points-at "$commit" \
              | grep -E '^release\/[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$' \
              | sort -V \
              | tail -n 1
          }

          STABLE_VERSION=$(get_version_for_track stable)
          BETA_VERSION=$(get_version_for_track beta)
          LEGACY_VERSION=$(get_version_for_track legacy)

          echo "stable=$STABLE_VERSION" >> "$GITHUB_OUTPUT"
          echo "beta=$BETA_VERSION" >> "$GITHUB_OUTPUT"
          echo "legacy=$LEGACY_VERSION" >> "$GITHUB_OUTPUT"

      - name: Print detected versions
        run: |
          echo "Stable: ${{ steps.get-tags.outputs.stable }}"
          echo "Beta:   ${{ steps.get-tags.outputs.beta }}"
          echo "Legacy: ${{ steps.get-tags.outputs.legacy }}"
